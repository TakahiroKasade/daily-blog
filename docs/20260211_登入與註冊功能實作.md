# 20260211 Phase 3: 登入/註冊功能實作

**日期**：2026/02/11
**範圍**：Phase 3 — 自訂登入與註冊頁面 (Login & Register UI)
**模式**：Mentor Mode (導師模式) — 所有程式碼由學習者手動撰寫

## 🎯 完成項目
- [x] `LoginController.java` (登入頁面控制器)
- [x] `SecurityConfig.java` 更新 (loginPage + register permitAll)
- [x] `login.html` (自訂登入頁面 + 錯誤提示)
- [x] `RegisterController.java` (註冊控制器 + Guard Clause)
- [x] `register.html` (註冊表單 + 密碼確認)
- [x] `DataSeeder.java` 管理員帳號初始化 (Phase 2 補完)
- [x] `index.html` 前端權限控制 sec:authorize (Phase 2 補完)

## 📁 異動檔案
| 檔案路徑 | 異動類型 | 說明 |
|----------|---------|------|
| `controller/LoginController.java` | 新增 | GET `/login` → 回傳 login.html |
| `controller/RegisterController.java` | 新增 | GET/POST `/register`，含密碼比對與 BCrypt 加密 |
| `config/SecurityConfig.java` | 修改 | 加入 `.loginPage("/login")`、`/register` permitAll |
| `config/DataSeeder.java` | 修改 | 新增管理員帳號初始化邏輯 |
| `templates/login.html` | 新增 | 自訂登入表單 + 錯誤提示 |
| `templates/register.html` | 新增 | 註冊表單 + 密碼確認欄位 |
| `templates/index.html` | 修改 | 加入 Login/Logout 按鈕、Admin 權限控制 |

## 🧠 核心概念 Q&A

### Q1: login.html 的 `name` 屬性跟 User Entity 有什麼關係？
**答**：登入表單的 `name="username"` 和 `name="password"` **不是直接對應 User Entity**，而是 **Spring Security 預設規定的參數名稱**。Spring Security 內建的攔截器會自動擷取這兩個值，然後透過 `CustomUserDetailsService.loadUserByUsername()` 間接查詢 User Entity。

流程鏈：表單 → Spring Security → CustomUserDetailsService → UserRepository → User Entity → 資料庫

### Q2: 為什麼有登入頁面但我沒建 login.html？
**答**：Spring Security 有**內建的預設登入頁面**。當你設定了 `.formLogin()` 但沒指定 `.loginPage()`，Spring Security 會自動生成一個簡易的 `/login` 頁面。指定 `.loginPage("/login")` 後，就會使用你自訂的頁面。

### Q3: 怎麼判斷哪些路徑是「公開清單」？
**答**：看 `SecurityConfig` 裡的 `requestMatchers(...).permitAll()`。Spring Security 會從上到下比對：
- 有匹配 → 套用該規則 (permitAll = 放行)
- 都沒匹配 → 走 `anyRequest().authenticated()` (要登入)

### Q4: Guard Clause 是什麼模式？
**答**：在方法開頭先檢查「不合法的情況」並提前 return，通過的才繼續往下執行。好處是不用巢狀 if-else，程式碼更清晰。
```java
if (!password.equals(confirmPassword)) {
    return "redirect:/register?error";   // 提前離開
}
// 只有合法情況才走到這裡
User user = new User();
...
```

### Q5: Register 的 `name` 屬性跟 Login 有何不同？
**答**：
- **Login 的 `name`**：給 Spring Security 攔截器用，名稱是固定的 (`username`, `password`)
- **Register 的 `name`**：給你自己的 `RegisterController` 用，名稱要跟 `@RequestParam` 一致就好

## 🔧 程式碼變更重點

### LoginController.java
```java
@Controller
public class LoginController {
    @GetMapping("/login")
    public String login(){
        return "login";
    }
}
```

### RegisterController.java
```java
@Controller
public class RegisterController {
    private UserRepository userRepository;
    private PasswordEncoder passwordEncoder;

    // 建構子注入 ...

    @GetMapping("/register")
    public String showRegisterForm(){
        return "register";
    }

    @PostMapping("/register")
    public String registerUser(@RequestParam String username,
                               @RequestParam String password,
                               @RequestParam String confirmPassword){
        if(!password.equals(confirmPassword)){
            return "redirect:/register?error";     // Guard Clause
        }
        User user = new User();
        user.setUsername(username);
        user.setPassword(passwordEncoder.encode(password));
        user.setRole("USER");
        userRepository.save(user);
        return "redirect:/login";
    }
}
```

### SecurityConfig.java (異動部分)
```java
.requestMatchers("/", "/register", "/css/**", "/js/**", "/images/**").permitAll()

.formLogin((form) -> form
    .loginPage("/login")              // 指向自訂登入頁面
    .defaultSuccessUrl("/", true)
    .permitAll()
)
```

## 📝 備註
- **Phase 3: Login & Register 完成！** 🎉
- 所有程式碼均由學習者手動撰寫 (Mentor Mode)。
- 下一步：美化登入/註冊頁面 UI、考慮加入「帳號已存在」的錯誤處理。
